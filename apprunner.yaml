version: 1.0
runtime: docker
build:
  commands:
    build:
      - echo "Building with Docker runtime using Dockerfile.dev for linux/amd64"
      - docker build --platform linux/amd64 -f Dockerfile.dev -t tinypixo-audio:v2.0.0 .
run:
  runtime-version: docker
  command: docker run -p 3000:3000 tinypixo-audio:v2.0.0
  network:
    port: 3000
    env: PORT
  env:
    # Core application settings
    - name: NODE_ENV
      value: production
    - name: BODY_SIZE_LIMIT
      value: 500mb
    - name: NEXT_SHARP_PATH
      value: /app/node_modules/sharp
    
    # AWS service configuration
    - name: AWS_REGION
      value: us-east-1
    - name: FORCE_AWS_ENVIRONMENT
      value: true
    
    # Audio conversion settings
    - name: FFMPEG_PATH
      value: /usr/local/bin/ffmpeg
    - name: FFMPEG_THREADS
      value: auto
    - name: FFMPEG_BUFFER_SIZE
      value: 64k
    - name: AUDIO_CONVERSION_TIMEOUT
      value: 300
    
    # Memory and performance optimizations
    - name: NODE_OPTIONS
      value: --max-http-header-size=16384 --max-old-space-size=2048
  
  # Production AWS service endpoints (to be configured in App Runner console)
  secrets:
    - name: S3_BUCKET_NAME
      from_parameter_store: /audio-converter/s3-bucket-name
    - name: REDIS_ENDPOINT
      from_parameter_store: /audio-converter/redis-endpoint
    - name: REDIS_PORT
      from_parameter_store: /audio-converter/redis-port
    - name: REDIS_TLS
      from_parameter_store: /audio-converter/redis-tls
